import { Cart } from '@commercetools/platform-sdk';
import { ValidateCouponsResult } from '../types';
import { CartAction } from './CartAction';

export default function removeFreeLineItemsForNonApplicableCoupon(
  cart: Cart,
  validateCouponsResult: ValidateCouponsResult,
): CartAction[] {
  const cartActions: CartAction[] = [];
  const { productsToAdd } = validateCouponsResult;
  cart.lineItems
    .filter((item) => item.custom?.fields?.applied_codes)
    .filter((item) => {
      const isCouponWhichNoLongerExist = item.custom?.fields?.applied_codes
        .map((code) => JSON.parse(code))
        .filter((code) => code.type === 'UNIT')
        .find((code) =>
          productsToAdd.map((product) => product.code).includes(code.code),
        );

      return !isCouponWhichNoLongerExist;
    })
    .forEach((item) => {
      const quantityFromCode = item.custom?.fields.applied_codes
        .map((code) => JSON.parse(code))
        .filter((code) => code.type === 'UNIT')
        .find(
          (code) =>
            !productsToAdd.map((unitCode) => unitCode.code).includes(code.code),
        ).quantity;

      if (item.quantity > quantityFromCode) {
        cartActions.push({
          action: 'setLineItemCustomField',
          lineItemId: item.id,
          name: 'applied_codes',
        });
      }

      cartActions.push({
        action: 'removeLineItem',
        lineItemId: item.id,
        quantity: quantityFromCode,
      });
    });

  return cartActions;
}
